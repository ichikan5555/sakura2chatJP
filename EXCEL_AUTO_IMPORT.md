# Excel自動取り込み機能

Dropboxフォルダを監視して、Excelファイルからルールを自動的に取り込む機能です。

## 📁 フォルダ構成

```
D:\JP Dropbox\商品一覧\メール2チャット\
├── インポート/          ← ここにExcelファイルを置く
├── インポート完了/      ← 成功したファイルが自動的に移動
└── インポート失敗/      ← 失敗したファイルが自動的に移動
```

## 🚀 使い方

### 1. サービスの起動

```bash
cd ~/sakura2chatJP

# PM2で起動
pm2 start ecosystem.config.cjs

# または個別に起動
pm2 start scripts/excel-auto-import.js --name excel-auto-import
```

### 2. Excelファイルの配置

1. Dropboxの `インポート` フォルダにExcelファイル（.xlsx）を置く
2. **数秒以内に自動的に取り込まれる**
3. 処理結果に応じて自動的にファイルが移動：
   - ✅ **全行成功** → `インポート完了` フォルダへ移動
   - ❌ **1行でも失敗** → `インポート失敗` フォルダへ移動

### 3. サービスの確認

```bash
# サービスの状態確認
pm2 status

# ログを見る（リアルタイム）
pm2 logs excel-auto-import

# ログを見る（過去のログ）
pm2 logs excel-auto-import --lines 100
```

### 4. サービスの停止・再起動

```bash
# 停止
pm2 stop excel-auto-import

# 再起動
pm2 restart excel-auto-import

# 削除（完全停止）
pm2 delete excel-auto-import
```

## 📊 Excelファイルの形式

以下の列が必要です：

| ルール名 | 受信メールアドレス | 相手メールアドレス | 受信件名（部分一致） | チャットワークルームID |
|---------|------------------|------------------|---------------------|---------------------|
| 例: 営業部 | example@mail.com | customer@example.com | 見積もり | 123456789 |

### 各列の説明

- **ルール名**: ルールの識別名（必須）
- **受信メールアドレス**: どのメールアカウントで受信するか（空白 or "全アカウント" = 全アカウント対象）
- **相手メールアドレス**: 送信者のメールアドレス（部分一致、カンマ区切りで複数指定可能）
- **受信件名（部分一致）**: 件名の検索キーワード（部分一致、カンマ区切りで複数指定可能）
- **チャットワークルームID**: 転送先のチャットワークルームID（必須）

### 高度な検索構文

- **複数条件**: カンマ区切りで複数指定可能
  - 例: `営業部,見積もり,問い合わせ`
- **NOT検索**: `NOT:` プレフィックスで除外
  - 例: `見積もり,NOT:spam`
- **ドメイン検索**: `@` を含まないドメインで検索
  - 例: `example.com` → `@example.com` のメールを検索

## 🔧 トラブルシューティング

### サービスが起動しない

```bash
# ログを確認
pm2 logs excel-auto-import --err

# 手動で実行してエラーを確認
node scripts/excel-auto-import.js
```

### フォルダが見つからない

- Dropboxが同期されているか確認
- フォルダパスが正しいか確認
- フォルダのアクセス権限を確認

### ファイルが取り込まれない

1. ログを確認: `pm2 logs excel-auto-import`
2. Excelファイルの形式を確認（必須列があるか）
3. サービスが起動しているか確認: `pm2 status`

### 一部の行が失敗する

- `インポート失敗` フォルダのファイルを確認
- ログで失敗理由を確認: `pm2 logs excel-auto-import`
- よくある原因:
  - ルール名が空
  - チャットワークルームIDが空
  - メールアカウントが存在しない

## 📝 ログファイル

ログは以下のファイルに保存されます：

```
~/sakura2chatJP/logs/
├── excel-import-out.log    ← 通常のログ
└── excel-import-error.log  ← エラーログ
```

## 🔄 自動起動設定（オプション）

PC起動時に自動的にサービスを開始する：

```bash
# PM2のスタートアップ設定
pm2 startup

# 現在の設定を保存
pm2 save
```

これで、PC再起動後も自動的にExcel取り込みサービスが起動します。
