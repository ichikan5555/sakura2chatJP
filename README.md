# さくらメール→Chatwork 自動転送ツール

さくらインターネットのメール（IMAP）で受信した新着メールを監視し、CSVで定義したルールに基づいてChatworkの特定ルームへ自動転送するツールです。

## ✨ 主な機能

- ✉️ **複数アカウント対応**: 複数のさくらメールアカウントを同時監視
- ⚡ **監視速度の個別設定**: 高速（30秒）・通常（60秒）・ゆっくり（90秒）から選択
- 📋 CSVファイルでルール定義（送信者・件名での絞り込み）
- 💬 Chatworkへメール内容を自動転送
- 🔐 パスワード自動導出機能（社内ルール対応）
- 🌐 Web管理画面でアカウント・ルール・設定管理
- 📊 転送ログ・統計表示

## 🚀 必要環境

- Node.js >= 22.0.0
- さくらメールアカウント（IMAP有効）
- Chatwork APIトークン

## 📦 セットアップ

### 1. 依存パッケージのインストール

```bash
cd D:\00Newapplication\sakura2chatJP
npm install
```

### 2. 環境変数の設定（任意）

ポート番号を変更する場合は `.env` ファイルを作成：

```bash
cp .env.example .env
```

`.env` の `PORT` を編集（デフォルト: 3001）

### 3. 起動

```bash
npm start
```

Web管理画面が `http://localhost:3001` で起動します。

**初回ログインパスワード**: `admin123`（起動後すぐに変更してください）

> **ポートが使用中の場合**: `.env` ファイルで `PORT=8080` など別のポートに変更してください

## ⚙️ アカウント管理

### Web UIでアカウント追加

1. `http://localhost:3000` にアクセス
2. 「アカウント管理」タブを選択
3. 「＋ アカウント追加」ボタンをクリック
4. 以下の情報を入力：

| 項目 | 説明 | 例 |
|------|------|------|
| アカウント名 | 識別用の名前 | `営業用メール` |
| IMAPサーバー | サーバーホスト名 | `monoshare.sakura.ne.jp` |
| ポート | IMAPポート | `993` |
| ユーザー名 | メールアドレス | `e14suger@monoshare.jp` |
| パスワードモード | `手動入力` または `自動生成` | - |
| 監視速度 | `⚡ 高速（30秒）` / `🔄 通常（60秒）` / `🐢 ゆっくり（90秒）` | 通常 |

### 監視速度の選択ガイド

| 速度 | 間隔 | 用途 |
|------|------|------|
| ⚡ **高速** | 30秒 | 緊急性の高いメール（サポート問い合わせ等） |
| 🔄 **通常** | 60秒 | 通常のビジネスメール |
| 🐢 **ゆっくり** | 90秒 | 定期レポート・ニュースレター等 |

### パスワード設定方法

#### 方法1: 手動入力

パスワードモードで「手動入力」を選択し、パスワードを直接入力します。

#### 方法2: 自動生成（社内ルール）

パスワードモードで「自動生成（社内ルール）」を選択し、PREFIX/SUFFIXを設定します。

**生成ルール:**

```
パスワード = PREFIX + (先頭1文字 + 末尾1文字 + ".") + SUFFIX
```

**例:** `e14suger@monoshare.jp` の場合
- メールアドレスの @ より前 = `e14suger`
- 先頭1文字 = `e`
- 末尾1文字 = `r`
- 中間部分 = `er.`
- **パスワード** = `araki0404.` + `er.` + `junpei0822.` = **`araki0404.er.junpei0822.`**

**設定値:**
- PREFIX: `araki0404.`
- SUFFIX: `junpei0822.`

## 📋 ルール設定

### CSVフォーマット

```csv
ルール名,送信者メアド,件名キーワード,転送先ルームID
請求書メール,billing@,請求書,95113089
見積もりメール,,見積,95113089
問い合わせ対応,support@,お問い合わせ,379701540
```

- **送信者メアド**: 部分一致（例: `billing@` で `billing@example.com` にマッチ）
- **件名キーワード**: 件名の部分一致
- **転送先ルームID**: ChatworkのルームID

Web管理画面から直接CSVをインポートすることもできます。

## 🌐 Web管理画面

### ダッシュボード

- 全アカウントの状態確認
- 過去24時間の転送統計

### アカウント管理

- アカウントの追加・編集・削除
- 監視速度の変更
- 接続テスト
- アカウントの有効/無効切り替え

### ルール管理

- 転送ルールの追加・編集・削除
- CSVインポート/エクスポート

### 転送ログ

- 転送履歴の確認
- ステータス別フィルタ

## 🔧 本番運用（PM2）

PM2で常駐させる場合：

```bash
npm install -g pm2
pm2 start ecosystem.config.cjs
pm2 save
pm2 startup
```

ログ確認：

```bash
pm2 logs sakura2chat
```

## 🔍 トラブルシューティング

### IMAP接続エラー

1. **アカウント管理画面で「接続テスト」を実行**
2. ホスト名・ポート・ユーザー名を確認
3. パスワード導出モードの場合、PREFIX/SUFFIXが正しいか確認
4. ファイアウォールでポート993が許可されているか確認

### Chatwork投稿エラー

- APIトークンが有効か確認
- ルームIDが正しいか確認
- レート制限に達していないか確認

### メールが転送されない

- ルールが有効になっているか確認
- ルールの条件（送信者・件名）が正しいか確認
- ログ画面で「skipped」になっていないか確認
- アカウントが有効になっているか確認

### ポーラーが停止している

- アカウント管理画面でアカウントのステータスを確認
- エラーメッセージを確認
- 「再起動」ボタンでポーラーを再起動

## 📝 API エンドポイント

### アカウント管理

- `GET /api/accounts` - 全アカウント取得
- `POST /api/accounts` - アカウント作成
- `PUT /api/accounts/:id` - アカウント更新
- `DELETE /api/accounts/:id` - アカウント削除
- `POST /api/accounts/:id/test` - 接続テスト
- `POST /api/accounts/:id/restart` - ポーラー再起動

### ルール管理

- `GET /api/rules` - 全ルール取得
- `POST /api/rules` - ルール作成
- `PUT /api/rules/:id` - ルール更新
- `DELETE /api/rules/:id` - ルール削除

### その他

- `GET /api/status` - システム状態
- `GET /api/logs` - 転送ログ
- `POST /api/auth/login` - ログイン
- `POST /api/auth/logout` - ログアウト

## 📄 ライセンス

ISC

## 👨‍💻 作成者

JP.Company

---

**更新履歴**

- v1.1.0: 複数アカウント対応、監視速度の個別設定機能を追加
- v1.0.0: 初版リリース
